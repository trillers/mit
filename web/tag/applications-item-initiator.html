<applications-item-initiator>
    <div class="applications-item" >
        <div class="div1">
            <div onclick="{toggleMoreInfo}"><img src={headImg} width="24" class="head-portrait" /> {applicantName}</div>

            <div onclick="{toggleMoreInfo}">
                <table>
                    <tr>
                        <td class="td1">{_displayName}</td>
                        <td>{num}人</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="clear"></div>
            <div class="div2 app_user_info">
                <div if="{moreOption}">
                    <table class="">
                        <tr each = "{name, i in appFieldNameArr}" if="{parent[name]}">
                            <td class=" td1" valign="top">{parent.appFields[name].title}：</td>
                            <td class=" td2">{parent[name]}</td>
                        </tr>
                    </table>
                </div>
                <div class="sms-tel">
                    <a href="sms:{phone}"><img src="{smsImg}" class="vertical"/> <span class="vertical">发短信</span></a>　<a href="tel:{phone}"><img src="{telImg}" class="vertical"/> <span class="vertical">打电话</span>　</a>
                </div>
            </div>
    </div>
    <script>
        var self = this;
        var _env = function() {
            if (__app.settings.env.NODE_ENV=="production"){
                return "public";
            }
            else{
                return "web";
            }
        }

        self.env = _env();
        console.log("env=" + self.env);

        var parent = this.opts.tag.parent;
        self.tag = this.opts.tag;
        self.initiator = parent.initiator;
        self.userId = parent.userId;
        self.smsImg = "/" + self.env + "/images/sms.png";
        self.telImg = "/" + self.env + "/images/tel.png";
        self.appFields = __page.appFields;
        self.appFieldNameArr = Object.keys(self.appFields);
        self.moreOption = false;

        var indexArr = [];
        var ifExist = false;
        for(var i = 0, len = self.appFieldNameArr.length; i < len; i++){
            if(self.appFieldNameArr[i] == "displayName" || self.appFieldNameArr[i] == "phone"){
                indexArr.push(i);
            }else{
                if(self.tag[self.appFieldNameArr[i]] && !ifExist){
                    self.moreOption = true;
                    ifExist = true;
                }
            }
        }
        for(var i = 0, len = indexArr.length; i < len; i++){
            self.appFieldNameArr.splice(indexArr[i],1);
            indexArr[i + 1] = indexArr[i + 1] - 1;
        }

        //judge if it is an initiator
        var _isNitiator = function(){
            var b = false;
            if (self.initiator==null){
                b = false;
            }
            else if (self.userId==null){
                b = false;
            }else if (self.initiator==self.userId){
                b = true;
            }else {
                b = false;
            }

            return b;
        }

        self.isNitiator = _isNitiator();

        //head Image to display from wechat
        var _headImg = function(){
            if (self.tag.applicant==null){
                var p = "/" + self.env + "/images/head.png";
                console.log("headImg=" + p);
                return p;
            }
            else if (self.tag.applicant.headImgUrl==null){
                var p = "/" + self.env + "/images/head.png";
                console.log("headImg=" + p);
                return p;
            }
            else{
                return self.tag.applicant.headImgUrl;
            }
        }

        self.headImg = _headImg();

        //name+phone string user filled when apply
        var __displayName = function(){

            if (self.isNitiator==true) {
                if (self.tag.displayName!=null){
                    return (self.tag.displayName + '/' + self.tag.phone);
                }
                else{
                    return self.tag.phone;
                }


            }else{
                return "";
            }

            //(dName==true)?((displayName!=null)?(displayName+'/'+phone):phone):phone

        }

        self._displayName = __displayName();

        //wechat nickname
        var _applicantName = function(){
            if (self.tag.applicant==null){
                return "匿名";
            }
            else{
                if (self.tag.applicant.displayName==null){
                    return "匿名";
                }
                else{
                    return self.tag.applicant.displayName;
                }
            }

            //applicant==null?'匿名':((applicant.displayName==null)?'匿名':applicant.displayName)
        }
        self.applicantName = _applicantName();

        toggleMoreInfo(e){
            $(e.currentTarget).parent().parent().find(".app_user_info").toggle();
        }
    </script>
</applications-item-initiator>

