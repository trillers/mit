<communication-index>
    <div if="{!hidden}">
        <div class="communication-index" onclick="{showEdit}" name="{commenter.displayName}" replyUserId="{commenter._id}">
            <div><img src={commenter.headImgUrl}  width="24" class="imgradius" /></div>
            <div>
                <p class="p1"><span>{commenter.displayName}：</span>{replyString}<span>{replyToName}</span>{comment}</p>
                <p class="p2"> {time} <span>&nbsp;&nbsp;</span><a onclick="{deleteComment}" alt="{_id}" class="delete" if="{commenter._id == window.__page.user.id}">删除</a></p>
            </div>
            <div class="clear"></div>
        </div>
    </div>
        <script>
            var self = this;
            self.env = (__app.settings.env.NODE_ENV=="production")?"public":"web";
            console.log("env=" + self.env);
            var parent = this.opts.tag.parent;
            var _id = this.opts.tag.parent._id;
            var crtOn = this.opts.tag.crtOn;
            self.replyString = (this.opts.tag.replyTo == '') ? '' : '回复 ';
            var deleteActivityComment = domain.action('deleteActivityComment');
            var date = util.formatDate(crtOn);
            self.time = date;
            self.update();
            deleteComment(e){
                console.log(e);
                var deleteId = $(e.target).attr("alt");
                var cm = {
                    "comment": "",
                    "commenter": "",
                    "commenterName": "",
                    "replyTo": "",
                    "replyToName": ""
                };
                var invocation = deleteActivityComment.newInvocation({id: _id, deleteId: deleteId});
                invocation.onDone(function(data){
                    parent.comments = data;
                    parent.update();
                }).onFail(function(err){
                    alert('delete comment failed');
                }).execute();
                e.stopPropagation();
            };

            showEdit(e){
                    var isSelect = $(e.currentTarget).parent().attr("class");
                    if(!isSelect){
                        var name = $(e.currentTarget).attr("name");
                        var replyUserId = $(e.currentTarget).attr("replyUserId");
                        var displayName = '';
                        try{
                            displayName = name ? name : '';
                        }catch(e){
                            displayName = '';
                        }
                        parent.replyToName = displayName;
                        parent.replyTo = replyUserId;
                        $("#interflow_reply").val("");
                        $("#interflow_reply").attr('placeholder',"回复 "+ displayName + ":");
                        $('.communication-index').parent().removeClass('com_wary_background_color');
                        $(e.currentTarget).parent().addClass("com_wary_background_color");
                        parent.consult = 1;
                        parent.update();
                        document.getElementById("interflow_reply").focus();
                    }else{
                        parent._resetFooterStyle();
                    }
                    e.stopPropagation();
                }

        </script>
</communication-index>