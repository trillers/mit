<activity-search>
    <div if="{!hidden}">
        <mask-loading show="{mask}"/>
        <div id="scroll_body" if="{!mask}">
            <mask-loading show = "{!ready}"/>
            <div class="search">
                <input type="text" name="name" id="search_info" placeholder="输入活动名搜索"/><input type="button" onclick="{search}" value="搜索"/>
            </div>
            <div class="search_placeholder"></div>
            <div id="pullDown" class="loading" style="display: none">
                <span class="pullDownIcon"></span><span class="pullDownLabel">正在刷新列表...</span>
            </div>
            <div class="activity-list">
                <activity-item class="activity-item" each={items} curritem="{this}"/>
                <activity-item class="activity-item" each={appended_list} curritem="{this}"/>
            </div>
            <div id="pullUp"  style="display: none">
                <span class="pullUpIcon"></span><span class="pullUpLabel">上拉加载更多活动...</span>
            </div>
            <div id="noResult" style="display: none;text-align:center;padding-top:80px;font-size:14px;color:#666;">
                <p><img src="/{env}/images/c_02.png" style="width: 35%" /></p>
                <p class="m_top10">抱歉，没有找到相关活动</p>
            </div>
            <!--底部 -->
            <div class="footer_placeholder"></div>
            <div class="footer" name="btnbox">
                <div onclick="{homepage}"></div>
                <div class="button publish" onclick="{showattention_by_publish}">发布活动</div>
            </div>
        </div>
    </div>
    <script>
        this.app = this.opts.app; //keep spa object
        var self = nest.presentable(this);
        self.env = (__app.settings.env.NODE_ENV == "production") ? "public" : "web";
        console.log("env=" + self.env);
        var name = this.name;
        var params = {
            sort: {'priorityRank':-1, 'rank':-1},
            page: {
                size: 10,
                no: 1
            },
            conditions: {
                status: {"$in": ['a', 're', 'ac', 'co']},
                reviewStatus:{"$in":['t', 'd']},
                privateFlag: false
            }
        };
        __page.tenant && (params.conditions.tenantId = __page.tenant);
        var collection = this.collection = nest.collectable({}, {
            url: __app.settings.api.url + "/pa/find",
            filter: params
        });
        var likeActivity = domain.action('likeActivity');
        var applyActivity = domain.action('applyActivity');
        var scrollBody,noResultEl, pullUpEl, pullUpOffset = 0,oldPosY = 0, newPosY = 0,allowRefresh = false;
        var stop=true;

        collection.on('fetch', function (models, o) {
            console.info('activities is fetched');
            self.items = models;
            self.appended_list = [];
            stop = (self.items.length % 10 == 0) ? true : false;
            self.update();
            self.trigger('ready', true);
            self.trigger('view-route-to');
            pullUpEl = document.getElementById("pullUp");
            noResultEl = $("#noResult");
            scrollBody = document.getElementById("scroll_body");
            resetPullUp(models);
            if(models.length != 0){
                if(models.length > 3){
                    $("#pullUp").show();
                }else{
                    $("#pullUp").hide();
                }
                noResultEl.hide();
            }else{
                $("#pullUp").hide();
                noResultEl.show();
            }
            openCall();
            hookLazyLoad();
            addwindowcilck();
            $(window).scrollTop("0px");
            pullUpEl.className = '';
            collection.trigger('fetched');
        });
        collection.on('fetched',function(){
            allowRefresh = true;
        });
        collection.on('append', function(models, o){
            console.info('activities is append');
            moveToStoreList(self.appended_list);
            self.appended_list = models;
            if(self.appended_list.length == 0){
                stop = false;
            }else {
                stop = (self.appended_list.length % 10 == 0) ? true : false;
            }
            self.update({appended_list: models});
            self.trigger('ready', true);
//            hookLazyLoad();
            resetPullUp(models);
        });

        var _search = function (filter) {
            this.trigger('ready', false);
            this.filter = filter || this.filter;
            collection.fetch({filter: this.filter});
        }.bind(self);

        var _append = function(){
            this.trigger('ready', false);
            collection.append({filter: this.filter});
        }.bind(self);

        var _refresh = function(){
            params.keyword = name.value.trim();
            params.page.no = 1;
            if(params.keyword.length == 0){
                util.tipssuccess(1,"搜索内容不能为空",1);
                setTimeout(function(){
                    $("#pullDown").hide();
                },300);
                return;
            }
            setTimeout(function(){
                $("#pullDown").hide();
                self.trigger('ready', false);
                _search();
            },500);
        }

        search(e){
            params.keyword = name.value.trim();
            params.page.no = 1;
            if(params.keyword.length == 0){
                util.tipssuccess(1,"搜索内容不能为空",1);
                return;
            }
            $("#pullDown").hide();
            self.trigger('ready', false);
            _search();
        };
        var onLikeActivity = function(data){
            self.items = self.items.concat(self.appended_list);
            for(var i=0;i<self.items.length;i++){
                if(self.items[i]._id == this.inputs[0]){
                    self.appended_list = [];
                    self.items[i].meta.likes = data;
                    self.update();
                    break;
                }
            }
        }
        var onApplyActivity = function(data){
            self.items = self.items.concat(self.appended_list);
            for(var i=0;i<self.items.length;i++){
                if(self.items[i]._id == this.inputs[0].id){
                    self.appended_list = [];
                    var num = 0;
                    for(var j = 0; j< data.length; j++){
                        num = num + data[j].num;
                    }
                    self.items[i].meta.apps = num;
                    self.update();
                    break;
                }
            }
        }
        this.on('mount', function(){
            console.info('tag activities is mounted');
            likeActivity.onDone(onLikeActivity);
            applyActivity.onDone(onApplyActivity);
        });
        this.on('unmount', function(){
            console.info('tag activities is unmounted');
            likeActivity.offDone(onLikeActivity);
            applyActivity.offDone(onApplyActivity);
        });

        this.on('open', function(options){
            console.info('tag activities is opening');
            this.trigger('ready', false);
            this.update();
            this.trigger('ready', true);
            self.trigger('view-route-to');
            document.getElementById("search_info").focus();
//            hookLazyLoad();
        });

        this.on('leave', function(){
            self.mask = true;
            self.update();
        });

        this.on('reenter', function(){
            self.mask = false;
            self.update();
        });

        this.on('show', function(cmd){
            self.trigger('ready', true);
            if(cmd){
                __page.holder().setTitle('搜索');
            }
            $(window).scrollTop(__page.holder().getTop());

        });
        var setType = function (){
            var values = __app.enums.ProductActivityStatus.values;
            var statusName = values[self.status];
            $(".pa_tyle").html(statusName)
        }

        var addwindowcilck = function(){
            $(document).on("click",function(){
                $(".footer_navs_wary").slideUp();
                $(".footer_navs_but").removeClass("footer_navs_but_hover");
            });
        }

        var hookLazyLoad = function(){
//            $("img.activity-cover-img").lazyload({ threshold : 200 ,effect:"fadeIn"});
            setImageHeight();
        };

        function setImageHeight() {
            var setHeight = Math.round($("#wary").width() * 360 / 640);
            $(".img1").css("height", setHeight+"px");
        }

        function moveToStoreList(list) {
            if (list != undefined) {
                list.forEach(function (item) {
                    self.items.push(item);
                });
                console.log('self.items ' + self.items.length);
            }
        }

        function resetPullUp(items) {
            console.log(items);
            if(items.length == 0){
                document.getElementById('pullUp').style.display = "none";
            }else{
                document.getElementById('pullUp').style.display = "block";
                pullUpEl.className = '';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多活动...';
            }
        }
        //返回首页
        homepage(e){
            riot.route('activity/index');
        }
        //发布页
        showattention_by_publish(){
            riot.route("activity/new");
        };
        var openCall = function(){
            scrollBody.addEventListener('touchstart', fn, false);
            scrollBody.addEventListener('touchmove', fn, false);
            scrollBody.addEventListener('touchend', fn, false);
            scrollBody.addEventListener('touchcancel', fn, false);
            function fn(event) {
                var event = event || window.event;
                switch (event.type) {
                    case "touchstart":
                        console.log('touchstart');
                        oldPosY = event.targetTouches[0].screenY;
                        break;
                    case "touchcancel":
                    case "touchend":
                        console.log('touchend');
                        if (pullUpEl.className.match('flip')) {
                            pullUpEl.className = 'loading';
                            pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
                            if (stop == true) {
                                stop = false;
                                params.page.no++;
                                _append();
                            }else{
                                document.getElementById('pullUp').style.display = "none";
                            }
                        }

                        break;
                    case "touchmove":
                        console.log('touchmove');
                        var touch = event.targetTouches[0];
                        //判断拖动的dom元素是否正确
                        var isTargetDom = false;
                        if($(touch.target)[0].tagName == 'IMG' && $(touch.target).attr("class").indexOf("activity-cover-img")>-1 && touch.pageY > 45){
                            isTargetDom = true;
                        }
                        newPosY = touch.screenY;
                        if((newPosY - oldPosY) > 0 && isTargetDom && $(window).scrollTop() === 0) {
                            if( allowRefresh ){
                                allowRefresh = false;
                                $("#pullDown").show();
                                _refresh();
                            }

                        }
                        var totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
                        __page.holder().saveTop($(window).scrollTop());

                        if (($(document).height() - 25 <= totalheight) && ($(document).height() <= totalheight)) {
                            if (!pullUpEl.className.match('flip')) {
                                pullUpEl.className = 'flip';
                                pullUpEl.querySelector('.pullUpLabel').innerHTML = '松开加载更多活动...';
//                               this.maxScrollY = this.maxScrollY;
                            }
                        } else if (($(document).height() - 50 <= totalheight) && ($(document).height() - 25 >= totalheight)) {
                            if (pullUpEl.className.match('flip')) {
                                pullUpEl.className = '';
                                pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多活动...';
//                               this.maxScrollY = pullUpOffset;
                            }
                        }
                        break;
                }
            }

            $(window).resize(function () {
                setImageHeight();
            });
            wx.ready(function(){
                //分享给朋友
                wx.onMenuShareAppMessage({
                    title: '快乐种子', // 分享标题
                    desc: '欢迎关注快乐种子，更多精彩活动等你参加！', // 分享描述
                    link: __page.holder().getBaseUrl()+"/index#activity/index", // 分享链接
                    imgUrl: __page.holder().getBaseUrl()+'/public/images/logo.png', // 分享图标
                    type: '', // 分享类型,music、video或link，不填默认为link
                    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                    success: function () {
                        // 用户确认分享后执行的回调函数
                    },
                    cancel: function () {
                        // 用户取消分享后执行的回调函数
                    }
                });
                //分享朋友圈
                wx.onMenuShareTimeline({
                    title: '快乐种子', // 分享标题
                    link: __page.holder().getBaseUrl()+"/index#activity/index", // 分享链接
                    imgUrl: __page.holder().getBaseUrl()+'/public/images/logo.png', // 分享图标
                    success: function () {
                        // 用户确认分享后执行的回调函数
                    },
                    cancel: function () {
                        // 用户取消分享后执行的回调函数
                    }
                });
            });

        }
    </script>
</activity-search>