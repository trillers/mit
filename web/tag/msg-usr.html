<msg-usr>
    <div if="{!hidden}">
        <input type="text" name="content"/>
        <input onclick="{sendToStu}" type="button" value="发送"/>
        <div each="{msgs}">
            <span>{from.name}</span>：<span>{content}</span>
        </div>
    </div>

    <script>
        var self = nest.presentable(this),
            MsgInClazzAddAction = domain.action('MsgInClazzAddAction'),
            MsgToUserLoadAction = domain.action('MsgToUserLoadAction'),
            rsId;
        self.msgs = [];
        self.userId;
        sendToStu(e){
            MsgInClazzAddAction.execute({
                channel: rsId,
                content: self.content.value
            });
            e.stopPropagation();
        }
        this.on('open', function(options){
            self.userId = options.userId;
            rsId = util.getRelationShip(self.userId, __page.user._id);
            MsgToUserLoadAction.execute({
                channel: rsId,
                to: self.userId
            })
        })
        this.on('mount', function(){
            MsgInClazzAddAction.onDone(OnMsgInClazzAddAction);
            MsgToUserLoadAction.onDone(OnMsgToUserLoadAction);
        })
        function OnMsgInClazzAddAction(data){
            console.log(data)
            self.msgs.unshift(data)
            self.content.value = ""
            self.update()
        }
        function OnMsgToUserLoadAction(docs){
            self.msgs = docs;
            self.trigger('view-route-to');
        }
    </script>
</msg-usr>