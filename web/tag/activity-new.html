<activity-new>
    <!--<mask-loading show="{!ready}"></mask-loading>-->
    <div id="addactbody" if="{!hidden}">
        <div class="activity-new-statement">
            <p>提醒：活动内容包含违法、反动信息或者冒用他人/组织的名义发布活动，平台有权删除其活动并提交公安机关处理</p>
            <img src="/{env}/images/closebtn3.png" class="closebtn3" onclick="{closeStatement}" />
        </div>
        <form id="actform">
            <div class="activity-new-basic-info">
                <section>
                    <div class="secleft"><img src="/{env}/images/new1.png" /></div>
                    <div class="secright">
                        <input type="text" onfocus="{inputonfocus}" onblur="{inputonblur}" name="name" value="" placeholder="活动名称"/>
                    </div>
                </section>
                <section class="tag-type">
                    <div class="secleft"><p class="p1"><img src="/{env}/images/new2.png" /></p> <p class="p2" onclick="{showSelectType}">类型标签</p></div>
                    <div class="secright">
                        <ul>
                            <li each="{name,i in typetags}" data="{name}" class="{tagdefault:true,checked:parent.currtypetags.indexOf(name)>=0} {(i==3||i==7)?'no_m_left':''}" onclick="{parent.selecttags}">
                                <i>{__app.enums.TypeTags.values[name]}</i>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="activity-time">
                    <div class="secleft"><img src="/{env}/images/new3.png" /></div>
                    <div class="secright">
                        <div class="fl div_left">活动时间</div>
                        <div class="fl div_right">
                            <div id="startTimebtn" class="datediv">
                                <input type="text" id="startTimetxt" value="00/00" readonly="readonly"/>
                                <input id="startTime" onchange="{startchange}" onclick="{dateclick}" onblur="{dateblur}" name="startTime" style="display: inline-block;margin-top:0px;" type="date"/>
                            </div>
                            <i></i>
                            <div id="endTimebtn" class="datedivright">
                                <input type="text" id="endTimetxt" value="00/00" readonly="readonly"/>
                                <input id="endTime" onchange="{endchange}" onclick="{dateclick}" onblur="{dateblur}" name="endTime" style="display: inline-block;margin-top:0px" type="date"/>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <div class="secleft"><img src="/{env}/images/new4.png" /></div>
                    <div class="secright">
                        <div></div>
                        <input type="text" onfocus="{inputonfocus}"  onblur="{inputonblur}" name="place" value="" placeholder="活动地点"/>
                    </div>
                </section>
                <section class="initiator">
                    <div class="secleft"><img src="/{env}/images/new5.png" /></div>
                    <div class="secright">
                        <div class="fl div_left">发起人</div>
                        <div class="fl div_right">
                            <div><input type="text" id="displayName" onfocus="{inputonfocus}"  onblur="{inputonblur}" name="initiatorName" placeholder="姓名" value="{__page.user.displayName}"/></div>
                            <div><span class="borderleft"></span><input type="text" onfocus="{inputonfocus}" id="phone" onblur="{inputonblur}" name="initiatorContact" placeholder="联系方式"/></div>
                        </div>
                    </div>
                </section>
                <section class="deadline">
                    <div class="secleft"><img src="/{env}/images/new6.png" /></div>
                    <div class="secright">
                        <div class="fl div_left">报名截止</div>
                        <div class="fl div_right">
                            <div class="datediv datediv360">
                                <input id="closingTimebtn" type="text" attr="closingTime" value="00/00" readonly="readonly"/>
                                <input id="closingTime"  onchange="{closingchange}" onclick="{dateclick}" onblur="{dateblur}" name="closingTime" style="display: inline-block;margin-left:0;" type="date"/>
                            </div>
                        </div>
                    </div>

                </section>
            </div>
            <div class="activity-new-activity-introduction-title">
                <div class="activity_title">
                    <span></span>
                    活动介绍
                </div>
            </div>
            <div id="editor"></div>
            <!--<div id="textareadiv" style="text-align: center;position: relative;">-->
                <!--<div id="textareatips" if="{util.getCookie('ReadedPushlishTips') && util.getCookie('ReadedPushlishTips') === 'true'}" style="display:none;position: absolute;top:20px;width:85%;left:6.5%;padding:1%;height:60px;line-height: 30px;background-color:rgb(52, 168, 168);border-radius: 5px;color:white;text-align: justify;">-->
                    <!--<div style="border-left:10px solid transparent;border-top:15px solid rgb(52, 168, 168);border-right:10px solid transparent;position: absolute;top:65px;left:50px;"></div>-->
                    <!--<div style="text-align: justify;"><span style="display: inline-block;line-height: 30px;margin-left: 2%;font-size:13px;">活动内容越详细越吸引小伙伴儿哦！下面的内容喜欢就接着写，不爽就清空它从头来过：）</span></div>-->
                <!--</div>-->
                <!--<textarea style="box-shadow: inset 0 0 0 white;text-shadow: none" class="actintro" name="desc" onfocus="{inputonfocus}"  onblur="{inputonblur}"></textarea>-->
            <!--</div>-->
            <div class="banner" onclick="{uploadimg}" if={test} style="position: relative">
                <img style="width: 100%" src="/{env}/images/pabannershow.png"/>
            </div>
            <div class="banner" onclick="{uploadimg}" if="{!test}" style="position: relative">
                <div style="position: absolute;bottom:10px;right:10px;width:24px;height:24px;z-index: 100;">
                    <img style="width:24px;height:24px" src="/{env}/images/5.0.8.png"/>
                </div>
                <img id="banner" style="width: 100%;" src={imgsrc}/>
            </div>
            <div class="activity-new-more-options-title activity-new-more-options-title-checked" onclick="{moreOptions}">
                <div class="activity_title">
                    <span></span>
                    更多选项
                </div>
            </div>
            <div class="options activity-new-more-options">
                <div class="new_hint_div1_div2">
                    <p>只允许被邀请的朋友参与</p>
                    <div class="but_wary" id="but_wary">
                        <p id="but_radius"></p>
                    </div>
                </div>
                <div class="user_options">
                    <div class="new_hint_div1_div3">
                        <p>报名填写项</p>
                    </div>
                    <ul onclick="{userOptions}">
                        <li each="{name,i in appFieldNameArr}" data="{name}" class="{i < 2 || name == 'desc' ? 'checked':''}">{__page.appFields[name].title}</li>
                    </ul>
                </div>
            </div>
            <div class="clear"></div>
            <div class="activity-new-presentation">
                <div>
                    <p class="new_hint_p1">提示:</p>
                    <p class="new_hint_p2">请确认活动内容后再发布!因为一旦发布并且有用户报名后,活动就不允许取消和修改了。</p>
                </div>
            </div>
            <div class="clear"></div>
            <div class="serv t-c">
                <p>使用过程中如有任何疑问请咨询客服</p>
                <p class="m_top10_media p2"><img src="/{env}/images/1_19.png" /> 客服电话：400-680-9072</p>
            </div>
            <div class="footer_placeholder"></div>
            <div class="footer" name="btnbox">
                <div onclick="{homepage}"></div>
                <div class="button but1" style="width:27%;" onclick="{submitdraft}">保存草稿</div>
                <div class="button but2" style="width:45%;" onclick="{publishpa}">立即发布</div>
            </div>
        </form>
    </div>

    <script>
        var self = nest.presentable(this);
        self.env = (__app.settings.env.NODE_ENV=="production")?"public":"web";
        var introImgs = {
            localIds:[],
            fileNames:[],
            serverIds:[],
            refresh: function(){
                this.localIds = [];
                this.serverIds = [];
                this.fileNames = [];
            }
        };
        var loadContact = domain.action('loadContact');
        var multiImgUpload = domain.action('multiImgUpload');
        var judgeIfTenantMember = domain.action('judgeIfTenantMember');
        //富文本编辑器
        var editor = new util.wedgt.WcEditor({
            modules:{
                Bold: true,
//                Size: true,
                Color: true,
                Img: true,
                TextAlign: true
            },
            container: 'editor'
        });
        var introImgsObjs = [];
        var currentImgShots = null, imgArr = [];
        var coverimgs = {
                localIds:[],
                serverIds:[],
                refresh:function(){
                    this.localIds = [];
                    this.serverIds = [];
                }
            },
            imgmodel = this.imgmodel = nest.modelable({}, {
                url: __app.settings.api.url + "/img/"
            }),
            model = this.model = nest.modelable({}, {
                url: __app.settings.api.url + "/pa/"
            }),
            startTimetxt = this.startTimetxt,
            startTime = this.startTime,
            endTimetxt = this.endTimetxt,
            endTime = this.endTime,
            closingTimebtn = this.closingTimebtn,
            closingTime = this.closingTime,
            name = this.name,
            place = this.place,
            initiator = __page.user.id,
            initiatorName = this.initiatorName,
            initiatorContact = this.initiatorContact,
            desc = this.desc,
            actform = this.actform,
            btnbox = this.btnbox,
            newdate = new Date(__page.servertime);
        self.appFields = __page.appFields;
        self.appFieldNameArr = Object.keys(self.appFields);
        var enums_TypeTags = __app.enums.TypeTags.values;
        delete enums_TypeTags["ex"];
        delete enums_TypeTags["tn"];
        self.typetags = Object.keys(enums_TypeTags); 
        self.test = true;
        self.actobj={
            txtareastr:'【活动主题】</br></br> 【活动日程】</br>   8：00 在xx集合；</br>【费用说明】</br>【报名说明】</br>    1、直接系统报名，队友名单中显示用户名字即报名成功；</br>    2、本活动不限名额。</br>【温馨提示】',
            initPage:function(){
                startTimetxt.value = util.dateFormat(newdate, 'MM/dd');
                endTimetxt.value = util.dateFormat(newdate, 'MM/dd');
                closingTimebtn.value = util.dateFormat(newdate, 'MM/dd');
                name.value = "";
                startTime.value = util.dateFormat(newdate, 'yyyy-MM-dd');
                endTime.value = util.dateFormat(newdate, 'yyyy-MM-dd');
                closingTime.value = util.dateFormat(newdate, 'yyyy-MM-dd');
                place.value ="";
                initiator = __page.user.id;
                initiatorName.value = __page.user.displayName;
                initiatorContact.value = "";
                //desc.value = this.txtareastr;
                editor.setContentHtml(this.txtareastr);
                var invocation = loadContact.newInvocation(__page.user.id);
                invocation.onDone(function(data){
                    if(data.contact){
                        $("#displayName").val(data.contact.displayName);
                        $("#phone").val(data.contact.phone);
                    }
                }).execute();
                introImgsObjs = [];
                coverimgs.refresh();
                introImgs.refresh();
                setaddEventListeners();
                setisShwoStatement();
                butResult = false;
                $(".but_wary").addClass("but_left");
                $(".but_wary").removeClass("but_right");
            },
            getJsondata :function(cb){
                var jsondata = {
                    name:name.value.trim(),
                    startTime: startTime.value || newdate,
                    endTime: endTime.value || newdate,
                    place: place.value.trim(),
                    initiator: __page.user.id,
                    initiatorName: initiatorName.value.trim(),
                    initiatorContact: initiatorContact.value.trim(),
                    closingTime: closingTime.value.trim() || newdate,
                    pics:[],
//                    desc:desc.value.trim(),
                    desc: editor.getContentHtml() && util.events.htmlToTemplate(editor.getContentHtml()) || self.actobj.txtareastr,
                    applicationFields: getApplicationFields()
                };

                jsondata['tags'] = {
                    region:'',
                    custom:'',
                    type:self.currtypetags || []
                };
                return jsondata;
            },
            validatefield:function(jsondata){
                console.log(validator);
                var errorarr = [];
                //doFormCheck
                if(validator.empty(jsondata.name)){
                    errorarr.push("活动名称不能为空");
                }
                if(self.currtypetags.length <= 0){
                    errorarr.push("请选择类型");
                }
                if(validator.empty(jsondata.place)){
                    errorarr.push("活动地点不能为空");
                }
                if(validator.empty(jsondata.initiatorName)){
                    errorarr.push("请填写发起人姓名");
                }
                if(validator.empty(jsondata.initiatorContact)){
                    errorarr.push("请填写发起人联系方式");
                }
                if(util.compareDate(util.dateFormat(newdate, 'yyyy-MM-dd'), startTime.value)){
                    errorarr.push("开始时间不能早于今天");
                }
                if(util.compareDate(startTime.value, endTime.value)){
                    errorarr.push("结束时间不能早于开始时间");
                }
                if(util.compareDate(closingTime.value, startTime.value)){
                    errorarr.push("截止时间不能晚于开始时间");
                }
                return errorarr;
            },
            submitform:function(jsondata){
                var me = this;
                //prehandler
                introImgs.refresh();
                introImgsObjs = [];
                imgArr = [];
                var $html= $(util.events._wrapdiv(editor.getContentHtml()));

                if(currentImgShots != null){
                    $html.find('img').each(function(i, e){
                        var exist = false;
                        for(var i = 0, len = currentImgShots.length; i < len; i ++){
                            var fileName = $(this).attr('fileName');
                             if(currentImgShots[i].name === fileName){
                                 imgArr.push(currentImgShots[i]);
                                 exist = true;
                                 break;
                             }
                        }
                        if(!exist){
                            introImgs.localIds.push($(this).attr('localid'));
                            introImgs.fileNames.push($(this).attr('fileName'));
                        }
                    })
                }else{
                    $html.find('img').each(function(i, e){
                        introImgs.localIds.push($(this).attr('localid'));
                        introImgs.fileNames.push($(this).attr('fileName'));
                    })
                }

                if(introImgs.localIds.length>0){
                    me._upload4Wx(introImgs.localIds, introImgs.serverIds, function(err){
                        if(err){
                            return util.tipssuccess(1, '上传图片失败', 0);
                        }
                        //push introimgs  && upload images
                        var image, imgShot;
                        for(var i = 0, len = introImgs.localIds.length; i < len; i++){
                            image = {
                                localId: introImgs.localIds[i],
                                name: introImgs.fileNames[i], //image original file ext.
                                mediaId: introImgs.serverIds[i]
                            };
                            introImgsObjs.push(image);
                        }
                        var invocation = multiImgUpload.newInvocation({imgArr: introImgsObjs});
                        invocation.onDone(function(data){
                            var docs = data, imgShot;
                            for(var j = 0, len = docs.length; j < len; j++){
                                imgShot = {
                                    id: docs[j]._id,
                                    name: docs[j].name,
                                    mediaId: docs[j].mediaId,
                                    localId: docs[j].localId
                                }
                                imgArr.push(imgShot);
                            };
                            model.set('introImgs', imgArr);
                            me._uploadPaObj(jsondata);
                        }).onFail(function(err){
                            alert('multiImgUpload fail');
                        }).execute();

//                        $.ajax({
//                            type: "post",
//                            url: __app.settings.api.url + "/img/images",
//                            data: {imgArr: introImgsObjs}
//                        }).success(function(data){
//                            var docs = data.result, imgShot;
//                            for(var j = 0, len = docs.length; j < len; j++){
//                                imgShot = {
//                                    id: docs[j]._id,
//                                    name: docs[j].name,
//                                    mediaId: docs[j].mediaId,
//                                    localId: docs[j].localId
//                                }
//                                imgArr.push(imgShot);
//                            };
//                            model.set('introImgs', imgArr);
//                            me._uploadPaObj(jsondata);
//                        });
                    });
                }else{
                    me._uploadPaObj(jsondata);
                }
            },
            _uploadPaObj: function(jsondata){
                //uploadimg
                if(coverimgs.localIds.length>0){
                    wx.uploadImage({
                        localId: coverimgs.localIds[0],
                        success: function (result) {
                            var image = {
                                name:util.getFileName(),
                                mediaId:result.serverId
                            }
                            imgmodel.set("myobj", image);
                            imgmodel.save();
                            imgmodel.off('save').on('save', function(res,o){
                                var imgsShot = [{
                                    id:res._id,
                                    mediaId:result.serverId,
                                    name:res.name
                                }];
                                jsondata.images = imgsShot;
                                //兼容代码--过期删除
                                jsondata.pics[0] = "/public/images/pabanner.png";
                                //如果是保存草稿，不清空图片
                                if(jsondata && jsondata.status && jsondata.status == 'd'){
                                    // _czc.push(["_trackEvent",util.getDc().PA.NAME,util.getDc().PA.ACTION.PUBLISH,self.currtypetags.join(','),self.initiator,'pubsubmitbtn']);
                                    model.set("query", {action:'draft'});
                                }else{
                                    // _czc.push(["_trackEvent",util.getDc().PA.NAME,util.getDc().PA.ACTION.PUBLISH,self.currtypetags.join(','),self.initiator,'draftsubmitbtn']);
                                    self.update();
                                    model.set("query", {action:'publish'});
                                }
                                jsondata && jsondata.status && (delete jsondata.status);
                                model.set("myobj", jsondata);
                                model.set("privateFlag", butResult);
                                model.save();
                            });
                        },
                        fail: function (res) {
                            console.error(JSON.stringify(res));
                        }
                    });
                }else{
                    if(jsondata && jsondata.status && jsondata.status == 'd'){
                        model.set("query",{action:'draft'});
                    }else{
                        model.set("query",{action:'publish'});
                    }
                    jsondata && jsondata.status && (delete jsondata.status);
                    jsondata.pics = ["/public/images/pabanner.png"];
                    model.set("myobj", jsondata);
                    model.set("privateFlag", butResult);
                    model.save();
                }
            },
            _upload4Wx:function(imgArr, resImgArr, cb) {
                var me = this;
                var len = imgArr.length, index = 0;
                function _Recursive(){
                    wx.uploadImage({
                        localId: imgArr[index],
                        success: function (result) {
                            resImgArr.push(result.serverId);
                            index++;
                            if(index <= len-1){
                                setTimeout(_Recursive, 500);
                            }else{
                                if(cb){
                                    return cb();
                                }else{
                                    return;
                                }
                            }
                        },
                        fail: function (res) {
                            cb(JSON.stringify(res));
                            console.error(JSON.stringify(res));
                        }
                    });
                }
                _Recursive();
            }
        };
        homepage(e){
            riot.route('activity/index');
        };
        var validator = util.validator();
        model.on('save',function(data,o){
            model.set('_id',data._id);
            //发布活动成功
            if(model.query.action == "publish"){
                _czc.push(['_trackEvent', util.getDc().PA.NAME + '(' + util.getDc().PA.ACTION.PUBLISH + ')', data.name || '', util.convertToValue(self.currtypetags).join(',') || '']);
                riot.route('#activity/createsuccess/_'+data._id);
            }
            //保存草稿成功
            if(model.query.action == "draft"){
                model && model.query && (delete model.query);
                util.tipssuccess(0,"保存成功");
                data && data.introImgs && (currentImgShots = data.introImgs);
            }
        });
        model.on('save-error',function(){
            util.tipssuccess(1,"保存失败");
        });
        model.on('error',function(){
            util.tipssuccess(1,"保存失败");
        });
        //更改标签
        selecttags(e){
            var curritem = e.item;
            var tagindex = self.currtypetags.indexOf(curritem.name);
            if(tagindex>=0){
                return self.currtypetags.splice(tagindex,1);
            }
            return self.currtypetags.push(curritem.name);
        };
        startchange(e){
            if(startTime.value == "" && util.getBrowser().android ===false){
                startTime.value = newdate;
                startTimetxt.value = util.dateFormat(newdate, 'MM/dd');
                return false;
            }

            startTimetxt.value = util.dateFormatstr(startTime.value);
            if(!endTime || endTime.value < startTime.value) {
                endTime.value = startTime.value;
                self.endchange();
            }
            if(!closingTime || closingTime.value > startTime.value) {
                closingTime.value = startTime.value;
                self.closingchange();
            }
        };
        endchange(e){
            if(endTime.value == "" && util.getBrowser().android === false){
                endTime.value = newdate;
                endTimetxt.value = util.dateFormat(newdate, 'MM/dd');
                return false;
            }
            endTimetxt.value = util.dateFormatstr(endTime.value);
        };
        closingchange(e){
            if(closingTime.value == "" && util.getBrowser().android === false){
                closingTime.value = newdate;
                closingTimebtn.value = util.dateFormat(newdate, 'MM/dd');
                return false;
            }
            closingTimebtn.value = util.dateFormatstr(closingTime.value);
        };
        publishpa(e){
            var jsondata = self.actobj.getJsondata();
            console.log("initiator=" + jsondata.initiator);
            jsondata["status"] = "o";
            var errorarr = self.actobj.validatefield(jsondata);
            if(errorarr.length>0){
                //errorHandler
                util.tipssuccess(1,errorarr[0],1);
                return;
            }
            if(__page.tenant && __page.user.wx_openid){
                var data = {};
                data.tenantId = __page.tenant;
                data.wx_openid = __page.user.wx_openid;
                var ifTenantMemInvocation = judgeIfTenantMember.newInvocation(data);
                ifTenantMemInvocation.onDone(function(result){
                    if(result){
                        jsondata.tenantId = __page.tenant;
                    }
                    self.actobj.submitform(jsondata);
                }).onFail(function(err){
                    util.tipssuccess(1,'用户授权失败',1);
                }).execute();
            }else{
                self.actobj.submitform(jsondata);
            }
        };
        submitdraft(e){
            var jsondata = self.actobj.getJsondata();
            jsondata["status"] = "d";
            var errorarr = self.actobj.validatefield(jsondata);
            if(errorarr.length>0){
                //errorHandler
                util.tipssuccess(1, errorarr[0], 1);
                return;
            }
            if(__page.tenant && __page.user.wx_openid){
                var data = {};
                data.tenantId = __page.tenant;
                data.wx_openid = __page.user.wx_openid;
                var ifTenantMemInvocation = judgeIfTenantMember.newInvocation(data);
                ifTenantMemInvocation.onDone(function(result){
                    if(result){
                        jsondata.tenantId = __page.tenant;
                    }
                    self.actobj.submitform(jsondata);
                }).onFail(function(err){
                    util.tipssuccess(1,'用户授权失败',1);
                }).execute();
            }else{
                self.actobj.submitform(jsondata);
            }
        };
        //展开更多选项
        moreOptions(e){
            $(".options").slideToggle();
            $(".activity-new-more-options-title").toggleClass("activity-new-more-options-title-checked");
        };
        //选择用户填写类型
        userOptions(e){
            if(e.target.outerText != "姓名" && e.target.outerText != "手机"){
                $(e.target).toggleClass("checked");
            }
        }
        var startX,endPageX, butResult = false;
        //设置按钮事件
        var setaddEventListeners =function(){
            var but_radius = document.getElementById("but_wary");
            but_radius.addEventListener("touchstart", touchStartBut_Radius, false);
            but_radius.addEventListener("touchmove", touchmoveBut_Radius, false);
            but_radius.addEventListener("touchend", touchendBut_Radius, false);
        };
        var touchStartBut_Radius = function(event){
            event.preventDefault();
            var event = event || window.event;
            startX = event.touches[0].pageX;
        };
        var touchmoveBut_Radius = function(event){
            event.preventDefault();
            var event = event || window.event;
            endPageX = event.touches[0].pageX;
        }
        var touchendBut_Radius = function(){
            if(endPageX>startX){
                $(".but_wary").addClass("but_right");
                $(".but_wary").removeClass("but_left");
                butResult = true;
            }else if(endPageX<startX){
                $(".but_wary").addClass("but_left");
                $(".but_wary").removeClass("but_right");
                butResult = false;
            }
            startX=0;
            endPageX=0;
        };
        var setisShwoStatement = function(){
            var isShow = util.getCookie("noSetatementShow");
            if(isShow) $(".activity-new-statement").hide();
        };
        self.on('toabsolute',function(){
            btnbox.style.position = "absolute";
            btnbox.style.bottom = "0px";
        });
        self.on('tofixed',function(){
            btnbox.style.position = "fixed";
            btnbox.style.bottom = "0px";
        });
        inputonfocus(e){
            self.trigger('toabsolute');
        };
        inputonblur(e){
            self.trigger('tofixed');
        };
        descfocus(e){
            self.trigger('toabsolute');
        };
        descblur(e){
            self.trigger('tofixed');
        };
        //iphone兼容
        var u = navigator.userAgent;
        if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)) {
            dateclick(e){
                self.trigger('toabsolute');
            };
            dateblur(e) {
                self.trigger('tofixed');
            };
        };
        showFootterNav(e){
            $(e.target).toggleClass("footer_navs_but_hover");
            var classNmae = $(e.target).attr("class");
            if(classNmae.indexOf("footer_navs_but_hover") < 0){
                $(".footer_navs_wary").slideUp(200);
            }else{
                $(".footer_navs_wary").slideDown(200);
            }
            e.stopPropagation();
        };
        //类型标签展开效果
        showSelectType(e){
            var className = $(".tag-type").attr("class");
            if(className.indexOf("animation-show") > 0){
                $(".tag-type").removeClass("animation-show").addClass("animation-hide");
            }else{
                $(".tag-type").removeClass("animation-hide").addClass("animation-show");
            }
        };
        //关闭信息
        closeStatement(e){
            $(".activity-new-statement").addClass("close_transition");
            util.setCookie("noSetatementShow","true","7");
        };
        var _open = function(filter){
            this.trigger('ready', false);
            this.update();
            this.trigger('ready', true);
            this.trigger('view-route-to');
            $('#textareadiv').one('click',function(){
                util.setCookie('ReadedPushlishTips', 'true', 30);
                $('#textareatips').remove();
            });
            //初始化富文本编辑器
            editor.init();
            editor.reset();
            $("#contentdiv").on("focus", function(){
                self.trigger('toabsolute');
            });
            $("#contentdiv").on("blur", function(){
                self.trigger('tofixed');
            });
            editor.off('chooseImgBegin').on('chooseImgBegin', function(opts) {
                wx.chooseImage({
                    success: function (res) {
                        editor.trigger('chooseImgComplete', res.localIds[0]);
                    }
                });
            });
        }.bind(self);
        this.on('mount', function(){
            console.info('tag activities is mounted');
        });

        this.on('show', function(cmd){
            if(cmd){
                __page.holder().setTitle('发布活动');
            }
            $(window).scrollTop(__page.holder().getTop());

        });

        this.on('open', function(options){
            _open(options);
            self.test = true;
            self.actobj.initPage();
            model && model._id && (delete model._id);
            model && model.query && (delete model.query);
            self.currtypetags = [];
            wx.ready(function(){
                self.uploadimg = function(e){
                    wx.chooseImage({
                        success: function (res) {
                            coverimgs.refresh();
                            coverimgs.localIds[0] = res.localIds[0];
                            self.test = false;
                            self.update();
                            var $banner = $("#banner");
                            $banner.attr("src",res.localIds[0]);
                        }
                    });
                };
                self.update();
            });
            $(window).scrollTop("0px");
        });

        //get application fields array
        var getApplicationFields = function(){
            var appFieldsArr = [];
            var appFieldsInfo = $(".user_options .checked");
            for(var i = 0; i < appFieldsInfo.length; i++){
                appFieldsArr.push(self.appFields[$(appFieldsInfo[i]).attr("data")]);
            }
            return appFieldsArr;
        }
        //newActivity.trigger('add',{abc:123});


    </script>
</activity-new>